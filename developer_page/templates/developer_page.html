{% load static %}
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>developer page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css'>
  <link rel="stylesheet" href="{% static 'developer_page/css/style.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<!-- partial:index.partial.html -->
<body class="sidebar-is-reduced">
  <header class="l-header">
    <div class="l-header__inner clearfix">
      <!-- <div class="c-header-icon js-hamburger">
        <div class="hamburger-toggle"><span class="bar-top"></span><span class="bar-mid"></span><span class="bar-bot"></span></div>
      </div>
      <div class="c-header-icon has-dropdown"><span class="c-badge c-badge--red c-badge--header-icon animated swing">13</span><i class="fa fa-bell"></i>
        <div class="c-dropdown c-dropdown--notifications">
          <div class="c-dropdown__header"></div>
          <div class="c-dropdown__content"></div>
        </div>
      </div> -->
      <!-- <div class="c-search">
        <input class="c-search__input u-input" placeholder="Admin Page" type="text"/>
      </div> -->
      <div style="width: 100%; text-align: center; font-size: 30px; color: #0944a2"><b>AMOIN DEVELOPER SERVICE</b></div>
      <div class="header-icons-group">
        <!-- <div class="c-header-icon basket"><span class="c-badge c-badge--blue c-badge--header-icon animated swing">4</span><i class="fa fa-shopping-basket"></i></div> -->
        <div class="c-header-icon logout"><i class="fa fa-power-off" onclick="location.href='/'"></i></div>
      </div>
    </div>
  </header>
  <div class="l-sidebar">
    <div class="logo">
      <div class="logo__txt">MENU</div>
    </div>
    <div class="l-sidebar__content">
      <nav class="c-menu js-menu">
        <ul class="u-list">
          <li class="c-menu__item is-active" data-toggle="tooltip" title="Fileupload & Result">
            <div class="c-menu__item__inner" onclick="location.href='#'"><i class="far fa-chart-bar"></i>
              <div class="c-menu-item__title"><span>Fileupload & Result</span></div>
            </div>
          </li>
          <!-- <li class="c-menu__item has-submenu" data-toggle="tooltip" title="Modules">
            <div class="c-menu__item__inner"><i class="fa fa-puzzle-piece"></i>
              <div class="c-menu-item__title"><span>Modules</span></div>
              <div class="c-menu-item__expand js-expand-submenu"><i class="fa fa-angle-down"></i></div>
            </div>
            <ul class="c-menu__submenu u-list">
              <li>Payments</li>
              <li>Maps</li>
              <li>Notifications</li>
            </ul>
          </li>
          <li class="c-menu__item has-submenu" data-toggle="tooltip" title="Statistics">
            <div class="c-menu__item__inner"><i class="far fa-chart-bar"></i>
              <div class="c-menu-item__title"><span>Statistics</span></div>
            </div>
          </li>
          <li class="c-menu__item has-submenu" data-toggle="tooltip" title="Gifts">
            <div class="c-menu__item__inner"><i class="fa fa-gift"></i>
              <div class="c-menu-item__title"><span>Gifts</span></div>
            </div>
          </li>
          <li class="c-menu__item has-submenu" data-toggle="tooltip" title="Settings">
            <div class="c-menu__item__inner"><i class="fa fa-cogs"></i>
              <div class="c-menu-item__title"><span>Settings</span></div>
            </div>
          </li>
        -->
        </ul>
      </nav>
    </div>
  </div>
</body>
<main class="l-main">
  <div class="content-wrapper content-wrapper--with-bg">
    <div class="page-title">
      <h1><b>배포 파일 분석</b></h1>
      <h3>파일 분석 버튼을 누르면 AI가 악성 파일인지 분석합니다.</h3>
      <form method="post" enctype="multipart/form-data" action="{% url 'file_analysis' %}">
        {{ form.as_p }}
        <button type="submit" style="background-color:#184a98">파일 분석</button>
      </form>
      {% if message %}
        <script>
            alert("{{ message|escapejs }}");
        </script>
      {% endif %}
    </div>
    <br>
    <h1 class="page-title"><b>AI 악성 파일 분석 결과</b></h1>
    <div class="page-content">
      <div style="overflow:hidden; height:auto;">
        <div id="chartContainer">
          <canvas id="myChart"></canvas>
        </div>
        <script>
          fetch('/api/chart-data/')
              .then(response => response.json())  // JSON 형태로 데이터를 받음
              .then(data => {
                  console.log(data);  // 데이터 확인용 콘솔 출력
                  const ctx = document.getElementById('myChart').getContext('2d');
                  const myChart = new Chart(ctx, {
                      type: 'doughnut',  // 도넛 차트
                      data: data,   // 서버에서 받아온 데이터 사용
                      options: {
                          responsive: true,
                          plugins: {
                              title: {
                                  display: true,
                                  text: data.options.plugins.title.text,
                                  font: {
                                    size: 16,
                                },
                              },
                              legend: {
                                  position: 'top',
                              },
                              tooltip: {
                                  callbacks: {
                                      label: function(tooltipItem) {
                                          let value = tooltipItem.raw;
                                          return `Value: ${value}%`;
                                      }
                                  }
                              }
                          }
                      }
                  });
              })
              .catch(error => console.error('Error fetching chart data:', error));  // 오류 처리
      </script>
        <style>
          #chartContainer {
            width: 45%;
            height: 45%;
            padding-left: 50px;
            padding-right: 50px;
            position: relative;
          }
        </style>
      </div>
    </div>
    <div style="text-align: center;">
      <a href="{% url 'reset_result' %}" style="margin-top: 10px; display: inline-block; padding: 10px 15px; background-color: #184a98; color: white; text-decoration: none; border-radius: 3px;">초기화</a>
      <a id="uploadButton" style="margin-top: 10px; display: inline-block; padding: 10px 15px; background-color: #184a98; color: white; text-decoration: none; border-radius: 3px; cursor: pointer;">업로드</a>

      <script>
        document.getElementById("uploadButton").addEventListener("click", function(event) {
          event.preventDefault();  // 기본 제출 동작을 막음
          
          // 서버에서 mal_rate 데이터를 받아옴
          fetch('/api/chart-data/')
              .then(response => response.json())
              .then(data => {
                  const malRate = data.datasets[0].data[0];  // mal_rate가 첫 번째 데이터에 있다고 가정
                  console.log("Mal Rate:", malRate);
      
                  if (malRate <= 10) {
                      // mal_rate가 10 이하인 경우 자동으로 파일 업로드 수행
                      uploadFile(malRate);
                  } else if (malRate >= 90) {
                      // mal_rate가 90 이상이면 업로드를 막음
                      alert("악성 비율이 90% 이상입니다. 파일을 업로드할 수 없습니다.");
                  } else {
                      // 10 < mal_rate < 90인 경우, 사용자에게 업로드 여부를 묻는 창을 표시
                      const userDecision = confirm("파일 악성 비율이 " + malRate + "%입니다. 파일을 업로드하시겠습니까?");
                      
                      if (userDecision) {
                          uploadFile(malRate);  // 사용자가 '네'를 선택하면 업로드 수행
                      } else {
                          alert("파일 업로드가 취소되었습니다.");
                      }
                  }
              })
              .catch(error => console.error('Error fetching chart data:', error));
        });
      
        // 파일 업로드 함수
        function uploadFile(malRate) {
            fetch("{% url 'confirm_upload' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",  // Django의 CSRF 토큰 처리
                },
                body: JSON.stringify({ mal_rate: malRate })  // 서버에 mal_rate 값을 전달
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("파일 업로드가 완료되었습니다.");
                    window.location.href = "{% url 'developer_page' %}";
                } else {
                    alert("파일 업로드에 실패했습니다: " + data.error);
                }
            })
            .catch(error => console.error('Error during file upload:', error));
        }
      </script>
      
    </div>
  </div>
</main>
<!-- partial -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script src='https://use.fontawesome.com/releases/v5.0.8/js/all.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js'></script>
<script  src="{% static 'developer_page/js/script.js' %}"></script>

</body>
</html>
